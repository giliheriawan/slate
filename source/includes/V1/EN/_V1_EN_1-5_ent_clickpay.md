# Enterprise - ClickPay
NICEPay offer **ClickPay** as Payment Method. Real time Notification will be send when customer completed the payment.<br>
Supported ClickPay by NICEPay:
<ol type="1">
  <li>Mandiri Clickpay
  <li>CIMB Clicks
  <li>BCA KlikPay
</ol>

Integration Step :
<ol type="1">
  <li>Merchant request ClickPay Registration to NICEPay.
  <li>NICEPay will be redirect to Bank Page.
  <li>Customer pay ClickPay in prefered payment channel.
  <li>NICEPay send notification
  <li>Merchant handle notification.
</ol>

## ClickPay Flow
Flow for Enterprise - ClickPay<br>
<img src="/images/ent-clickpay-flow.png">

## ClickPay Registration

```java
// Payment Mandatory Field
nicePay.setPayMethod("04");
nicePay.setCurrency("IDR");
nicePay.setAmt("1000");
nicePay.setReferenceNo("MerchantReferenceNumber001");
nicePay.setMitraCd("MDRC");
nicePay.setGoodsNm("Merchant Goods 1");
nicePay.setBillingNm("Buyer Name");
nicePay.setBillingEmail("buyer@merchant.com");
nicePay.setBillingPhone("02112345678");
nicePay.setBillingAddr("Billing Address");
nicePay.setBillingCity("Jakarta");
nicePay.setBillingState("Jakarta");
nicePay.setBillingPostCd("12345");
nicePay.setBillingCountry("Indonesia");
nicePay.setDeliveryNm("Buyer Name ");
nicePay.setDeliveryPhone("02112345678");
nicePay.setDeliveryAddr("Billing Address ");
nicePay.setDeliveryCity("Jakarta ");
nicePay.setDeliveryState("Jakarta ");
nicePay.setDeliveryPostCd("12345");
nicePay.setDeliveryCountry("Indonesia ");
nicePay.setCallBackUrl(merchantDomain + "callback");
nicePay.setDbProcessUrl(merchantDomain + "dbprocess");
nicePay.setVat("0");
nicePay.setFee("0");
nicePay.setNotaxAmt("0");
nicePay.setDescription("Description");
nicePay.setUserIP("127.0.0.1");
nicePay.setMerchantToken(nicePay.makeToken(nicePay.getAmt(), nicePay.getReferenceNo()));
nicePay.setCartData("{}");
nicePay.setClickPayNo("1234567890123456");
nicePay.setClickPayToken("000000");
nicePay.setDataField3("3");

// Payment Optional Field
nicePay.setReqDt("20160301");
nicePay.setReqTm("135959");
nicePay.setReqDomain("merchant.com");
nicePay.setReqServerIP("127.0.0.1");
nicePay.setReqClientVer("1.0");
nicePay.setUserSessionID("userSessionID");
nicePay.setUserAgent("Mozilla");
nicePay.setUserLanguage("en-US");
nicePay.setMerFixAcctId("9999000000000001");
nicePay.setPaymentExpiryDt("20160303");
nicePay.setPaymentExpiryTm("135959");


// Payment Request
nicePay.payment();

// Payment Response
System.out.println("Response String : " + nicePay.getResponseString()); // JSON in String format

String resultCd = nicePay.Get("resultCd");
String resultMsg = nicePay.Get("resultMsg");
String tXid= nicePay.Get("tXid ");
String referenceNo= nicePay.Get("referenceNo");
String receiptCode= nicePay.Get("receiptCode");
String payMethod= nicePay.Get("payMethod");
String amount= nicePay.Get("amount");
String transDt = nicePay.Get("transDt ");
String transTm = nicePay.Get("transTm ");
String description= nicePay.Get("description");
String callbackUrl= nicePay.Get("callbackUrl");
String mitraCd= nicePay.Get("mitraCd");
```

```csharp
protected void CheckOut(object sender, EventArgs e)
{
    if (!string.IsNullOrEmpty(BankCd.SelectedValue))
    {
        objNicepay.currency = "IDR";
        objNicepay.DateNow = DateTime.Now.ToString("yyyymmdd");
        // Set VA expiry date +1 day (optional)
        objNicepay.vaExpDate = DateTime.Now.AddDays(1).ToString("yyyymmdd");
        //Populate Mandatory parameters to send
        // payment type Bank
        objNicepay.PayMethod = "04";
        // Total gross amount
        objNicepay.amt = "10000";
        // Invoice Number or Referenc Number Generated by merchant
        objNicepay.referenceNo = generateReference();
        objNicepay.description = "Payment Invoice No. " + objNicepay.referenceNo;
        // Transaction description
        objNicepay.billingNm = "Donald Duck";
        objNicepay.billingPhone = "021987456321";
        objNicepay.billingEmail = "donald@duck.com";
        objNicepay.billingAddr = "King of money street";
        objNicepay.billingCity = "King";
        objNicepay.billingState = "Money";
        objNicepay.billingPostCd = "123654";
        objNicepay.billingCountry = "Indonesia";

        objNicepay.deliveryNm = "Donald Duck";
        objNicepay.deliveryPhone = "021987456321";
        objNicepay.deliveryEmail = "donald@duck.com";
        objNicepay.deliveryAddr = "King of money street";
        objNicepay.deliveryCity = "King";
        objNicepay.deliveryState = "Money";
        objNicepay.deliveryPostCd = "123654";
        objNicepay.deliveryCountry = "Indonesia";

        objNicepay.MitraCd = "MDRC";
        objNicepay.clickPayNo = "1234567890123456";
        objNicepay.clickPayToken = "000000";
        objNicepay.dataField3 = "3";


        objResult = objNicepayClass.CreateCVS(objNicepay);

        if (objResult.resultCd == "0000")
        {
            Tresult.InnerText = objResult.resultCd;
            TtXid.InnerText = objResult.tXid;
            TcallbackUrl.InnerText = objResult.callbackUrl;
            Tdescription.InnerText = objResult.description;
            TreferenceNo.InnerText = objResult.referenceNo;
            TpayMethod.InnerText = objResult.payMethod;
            //YYMMDD
            TtransDT.InnerText = objResult.transDt;
            //HH24MISS
            TTranstm.InnerText = objResult.transTm;
            receiptCode.InnerText = objResult.receiptCode;
            TresultMsg.InnerText = objResult.resultMsg;
            mitraCd.InnerText = objResult.mitraCd;
            amount.InnerText = objResult.amount;
            wrapper.Visible = false;
            Myresult.Visible = true;
        }
        else if (objResult.resultCd != null)
        {
            //API data Not correct, you can redirect back to checkout page Or echo error message.
            //In this sample, we echo error message
            EresultCd.InnerText = objResult.resultCd;
            EresultMsg.InnerText = objResult.resultMsg;
            wrapper.Visible = false;
            ErrData.Visible = true;
        }
        else
        {
            //Timeout, you can redirect back to checkout page Or echo error message.
            //In this sample, we echo error message
            ERR_.InnerText = "Connection Timeout. Please Try again.";
            wrapper.Visible = false;
            ERR.Visible = true;
        }
    }
}
```

```php
<?php
// Include Config File
include_once "lib/NicepayLib.php";
$nicepay = new NicepayLib();

function generateReference()
{
    $micro_date = microtime();
    $date_array = explode(" ",$micro_date);
    $date = date("YmdHis",$date_array[1]);
    $date_array[0] = preg_replace('/[^\p{L}\p{N}\s]/u', '', $date_array[0]);
    return "Ref".$date.$date_array[0].rand(100,999);
}

if(isset($_POST['payMethod']) && $_POST['payMethod'] == '04'
    && isset($_POST['mitraCd']) && $_POST['mitraCd'])
{
  $billingNm      = $_POST['billingNm'];
  $referenceNo    = $_POST['referenceNo'];
  $mitraCd         = $_POST['mitraCd'];

  // Populate Mandatory parameters to send
  $nicepay->set('payMethod', '04');
  $nicepay->set('currency', 'IDR');
  $nicepay->set('amt', 10000); // Total gross amount
  $nicepay->set('referenceNo', $referenceNo); // Invoice Number or Reference Number Generated by merchant
  $nicepay->set('description', 'Payment of Invoice No '.$nicepay->get('referenceNo')); // Transaction description
  $nicepay->set('mitraCd', $mitraCd);

  $nicepay->set('billingNm', 'John Doe'); // Customer name
  $nicepay->set('billingPhone', '02112345678'); // Customer phone number
  $nicepay->set('billingEmail', 'john@example.com'); //
  $nicepay->set('billingAddr', 'Jl. Jend. Sudirman No. 28');
  $nicepay->set('billingCity', 'Jakarta Pusat');
  $nicepay->set('billingState', 'DKI Jakarta');
  $nicepay->set('billingPostCd', '10210');
  $nicepay->set('billingCountry', 'Indonesia');

  $nicepay->set('deliveryNm', 'John Doe'); // Delivery name
  $nicepay->set('deliveryPhone', '02112345678');
  $nicepay->set('deliveryEmail', 'john@example.com');
  $nicepay->set('deliveryAddr', 'Jl. Jend. Sudirman No. 28');
  $nicepay->set('deliveryCity', 'Jakarta Pusat');
  $nicepay->set('deliveryState', 'DKI Jakarta');
  $nicepay->set('deliveryPostCd', '10210');
  $nicepay->set('deliveryCountry', 'Indonesia');

  // Send Data
  $response = $nicepay->requestClickPay();

  // Response from NICEPAY
  if (isset($response->resultCd) && $response->resultCd == "0000") {
    echo "<pre>";
    echo "tXid              : $response->tXid\n";
    echo "callbackUrl       : $response->callbackUrl\n";
    echo "description       : $response->description\n";
    echo "payment date      : $response->transDt\n"; // YYYYMMDD
    echo "payment time      : $response->transTm\n"; // HH24MISS
    echo "receipt Code      : $response->receiptCode\n";
    echo "result code       : $response->resultCd\n";
    echo "result message    : $response->resultMsg\n";
    echo "reference no      : $response->referenceNo\n";
    echo "payment method    : $response->payMethod\n";
    echo "</pre>";
  } elseif(isset($response->resultCd)) {
    // API data not correct or error happened in bank system, you can redirect back to checkout page or echo error message.
    // In this sample, we echo error message
    echo "<pre>";
    echo "Oops! Something happened, please notice your system administrator.\n\n";
    echo "result code       : $response->resultCd\n";
    echo "result message    : $response->resultMsg\n";
    echo "</pre>";
  } else {
    // Timeout, you can redirect back to checkout page or echo error message.
    // In this sample, we echo error message
    echo "<pre>Connection Timeout. Please Try again.</pre>";
  }
}
?>
```

```python
import json

from nicepay import NICEPay

#Set MID & Merchant Key
NICEPay.iMid = "BMRITEST01" #Set Merchant ID
NICEPay.merchantKey = "33F49GnCMS1mFYlGXisbUDzVf2ATWCl9k3R++d5hDd3Frmuos/XLx8XhXpe+LDYAbpGKZYSwtlyyLOtS/8aD7A==" #Set Merchant Key

#Set Mandatory Value
NICEPay.payMethod = "04" #Set Payment Method
NICEPay.amt = "1000" #Total Gross Amount
NICEPay.referenceNo = "NiceTest00003" #Invoice Number By Merchant
NICEPay.goodsNm = NICEPay.referenceNo #Goods Name
NICEPay.billingNm = "John Doe"
NICEPay.billingPhone = "02112345678"
NICEPay.billingEmail = "john@example.co`m"
NICEPay.billingAddr = "Jl. Jend. Sudirman No. 28"
NICEPay.billingCity = "Jakarta Pusat"
NICEPay.billingState = "DKI Jakarta"
NICEPay.billingPostCd = "10210"
NICEPay.billingCountry = "Indonesia"
NICEPay.callBackUrl = "http://example.com/callback"
NICEPay.dbProcessUrl = "https://example.com/notification-handler.php"
NICEPay.description = "Payment Of Ref No." + NICEPay.referenceNo
NICEPay.merchantToken = NICEPay.getMerchantToken()
NICEPay.userIP = NICEPay.getUserIp()
NICEPay.cartData = "{}" #Json Array Value
NICEPay.mitraCd = "MDRC"
NICEPay.clickPayNo = "1234567890123456"
NICEPay.clickPayToken = "000000"
NICEPay.dataField3 = "3"



# // Payment Request
resultData = NICEPay.apiRequest()
result = json.loads(resultData)

#Payment Response String Format
try:
    result['resultCd']
except NameError:
    print "Connection Timeout. Please Try Again!"
else:
    if result['resultCd'] == '0000':
        print("resultCd : " + result['resultCd'])
        print("resultMsg : " + result['resultMsg'])
        print("tXid : " + result['tXid'])
        print("referenceNo : " + result['referenceNo'])
        print("payMethod : " + result['payMethod'])
        print("amount : " + result['amount'])
        print("transDt : " + result['transDt'])
        print("transTm : " + result['transTm'])
        print("description : " + result['description'])
        print("callbackUrl : " + result['callbackUrl'])
        print("receiptCode : " + result['receiptCode'])
        print("mitraCd : " + result['mitraCd'])
    else:
        print("resultCd : " + result['resultCd'])
        print("resultMsg : " + result['resultMsg'])
```

> Sample JSON Response

```json
{
    "resultCd": "0000",
    "amount": "10000",
    "goodsNm": "Test Transaction Nicepay",
    "referenceNo": "99997",
    "transTm": "113152",
    "mitraCd": "MDRC",
    "tXid": "TESTIDTEST04201803011131521855",
    "description": "Payment of referenceNo 99997",
    "receiptCode": "1831B3127001",
    "resultMsg": "SUCCESS",
    "billingNm": "Customer Name",
    "mRefNo": "201803011131521884",
    "payMethod": "04",
    "callbackUrl": "http://www.merchant.com/callbackUrl",
    "currency": "IDR",
    "transDt": "20180301"
}
```

&nbsp; | &nbsp;
---------- | -------
**API url** | **/nicepay/api/onePass.do**
Method | POST
Description | ClickPay Transaction
Merchant Token | SHA256 (Merchant ID + Reference Number + Amount + Merchant Key)

<br>**Request POST Parameter**

Parameter | Mandatory | Type | Size | Description
---------- | ---------- | ---------- | ---------- | ----------
iMid | Y | AN | 10 | Merchant ID
payMethod | Y | AN | 2 | Pay Method, refer to [here](#payment-method)
currency | Y | AN | 3 | Currency
amt | Y | N | 12 | Goods Amount
referenceNo | Y | AN | 40 | Merchant Order No
goodsNm | Y | AN | 100 | Goods Name
billingNm | Y | A | 30 | Billing Name
billingPhone | Y | N | 15 | Billing Phone Number
billingEmail | Y | AN | 40 | Billing Email
billingCity | Y | A | 50 | Billing City
billingState | Y | A | 50 | Billing State
billingPostCd | Y | N | 10 | Billing Post Number
billingCountry | Y | A | 10 | Billing Country
callBackUrl | Y | AN | 255 | Payment Result Forward Url (On Browser)
dbProcessUrl | Y | AN | 255 | Payment Result Receive Url (Server Side)
description | Y | AN | 100 | Description
merchantToken | Y | AN | 255 | Merchant Token
userIP | Y | AN | 15 | User IP (Customer)
cartData | Y | AN | 4000 | Cart Data (Json Format)
mitraCd | Y | AN | 4 | Mitra Code, refer to [here](#mitra-code)
clickPayNo | Y | N | 16 | Clickpay card number
dataField3 | Y | N | 16 | Token input 3 for Clickpay
clickPayToken | Y | N | 6 | Code response from token
billingAddr | N | 100 | AN | Billing Address
deliveryNm | N | A | 30 | Delivery Name
deliveryPhone | N | N | 15 | Delivery Phone
deliveryAddr | N | AN | 100 | Delivery Address
deliveryEmail | N | AN| &nbsp; | Delivery Email
deliveryCity | N | A | 50 | Delivery City
deliveryState | N | A | 50 | Delivery State
deliveryPostCd | N | N | 10 | Delivery Post Number
deliveryCountry | N | A | 10 | Delivery Country
vat | N | N | 12 | Vat
fee | N | N | 12 | Service Tax
notaxAmt | N | N | 12 | Tax Free Amount
reqDt | N | N | 8 | Request Date(YYYYMMDD)
reqTm | N | N | 6 | Request Time(HH24MISS)
reqDomain | N | AN | 100 | Request Domain
reqServerIP | N | AN | 15 | Request Server IP
reqClientVer | N | AN | 50 | Request Client Version
userSessionID | N | AN | 100 | User Session ID
userAgent | N | AN | 100 | User Agent Information
userLanguage | N | AN | 2 | User Language

<br>**Response JSON Object**

Parameter | Type | Size | Description
---------- | ---------- | ---------- | ----------
resultCd | N | 4 | Result Code
resultMsg | AN | 255 | Result Message
tXid | AN | 30 | Transaction ID
referenceNo | ANS | 40 | Merchant Order No
payMethod | N | 2 | Payment Method. Refer Code at [Here](#payment-method)
amount | N | 12 | Transaction Amount
currency | AN | 3 | Currency
goodsNm | N | 100 | Goods Name
billingNm | N | 30 | Buyer Name
description | N | 100 | Transaction description
callbackUrl | N | 100 | Callback Url
mitraCd | AN | 4 | Mitra Code, refer to [Link](#mitra-code)
transDt | N | 8 | Transaction date (YYYYMMDD)
transTm  | N | 6 | Transaction Time (HH24MISS)
receiptCode | ANS | 20 | Authorization Number
mRefNo  | AN | 18 | Bank Reference No
